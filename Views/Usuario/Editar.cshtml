@model Usuario
@using Ong.Models

@{
    ViewData["Title"] = "Editar Perfil";
}

<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h4>Editar Perfil</h4>
                </div>
                <div class="card-body">
                    <form asp-action="Editar" method="post">
                        <div asp-validation-summary="ModelOnly" class="text-danger"></div>
                        <input type="hidden" asp-for="Tipo" />
                        
                        <h5>Informações Básicas</h5>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label asp-for="Nome" class="control-label">Nome</label>
                                    <input asp-for="Nome" class="form-control" required />
                                    <span asp-validation-for="Nome" class="text-danger"></span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label asp-for="EmailPrincipal" class="control-label">Email</label>
                                    <input asp-for="EmailPrincipal" class="form-control" required />
                                    <span asp-validation-for="EmailPrincipal" class="text-danger"></span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group mb-3">
                            <label asp-for="Telefone" class="control-label">Telefone</label>
                            <input asp-for="Telefone" class="form-control" required />
                            <span asp-validation-for="Telefone" class="text-danger"></span>
                        </div>
                        
                        <h5 class="mt-4">Endereço</h5>
                        <div class="form-group mb-3">
                            <label asp-for="Cep" class="control-label">CEP</label>
                            <input asp-for="Cep" class="form-control" id="cep" required />
                            <span asp-validation-for="Cep" class="text-danger"></span>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-9">
                                <div class="form-group mb-3">
                                    <label asp-for="Logradouro" class="control-label">Logradouro</label>
                                    <input asp-for="Logradouro" class="form-control" id="logradouro" required />
                                    <span asp-validation-for="Logradouro" class="text-danger"></span>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group mb-3">
                                    <label asp-for="Numero" class="control-label">Número</label>
                                    <input asp-for="Numero" class="form-control" id="numero" required />
                                    <span asp-validation-for="Numero" class="text-danger"></span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group mb-3">
                            <label asp-for="Complemento" class="control-label">Complemento</label>
                            <input asp-for="Complemento" class="form-control" id="complemento" />
                            <span asp-validation-for="Complemento" class="text-danger"></span>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-group mb-3">
                                    <label asp-for="Bairro" class="control-label">Bairro</label>
                                    <input asp-for="Bairro" class="form-control" id="bairro" required />
                                    <span asp-validation-for="Bairro" class="text-danger"></span>
                                </div>
                            </div>
                            <div class="col-md-5">
                                <div class="form-group mb-3">
                                    <label asp-for="Cidade" class="control-label">Cidade</label>
                                    <input asp-for="Cidade" class="form-control" id="cidade" required />
                                    <span asp-validation-for="Cidade" class="text-danger"></span>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group mb-3">
                                    <label asp-for="Estado" class="control-label">Estado</label>
                                    <input asp-for="Estado" class="form-control" id="estado" required />
                                    <span asp-validation-for="Estado" class="text-danger"></span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group mb-3" style="display: none;">
                            <label asp-for="Latitude" class="control-label">Latitude</label>
                            <input asp-for="Latitude" class="form-control" id="latitude" />
                        </div>
                        
                        <div class="form-group mb-3" style="display: none;">
                            <label asp-for="Longitude" class="control-label">Longitude</label>
                            <input asp-for="Longitude" class="form-control" id="longitude" />
                        </div>
                          <!-- Campos específicos de Doador -->
                        @if (Model.Tipo == TipoUsuario.Doador)
                        {
                            var doador = Model as Doador;
                            <div id="camposDoador">
                                <h5 class="mt-4">Informações de Doador</h5>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group mb-3">
                                            <label for="Cpf" class="control-label">CPF</label>
                                            <input id="Cpf" name="Cpf" class="form-control" value="@(doador?.Cpf ?? string.Empty)" />
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group mb-3">
                                            <label for="DataNascimento" class="control-label">Data de Nascimento</label>
                                            <input id="DataNascimento" name="DataNascimento" class="form-control" type="date" value="@(doador?.DataNascimento?.ToString("yyyy-MM-dd") ?? string.Empty)" />
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                          <!-- Campos específicos de Voluntário -->
                        @if (Model.Tipo == TipoUsuario.Voluntario)
                        {
                            var voluntario = Model as Voluntario;
                            <div id="camposVoluntario">
                                <h5 class="mt-4">Informações de Voluntário</h5>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group mb-3">
                                            <label for="Cpf" class="control-label">CPF</label>
                                            <input id="Cpf" name="Cpf" class="form-control" value="@(voluntario?.Cpf ?? string.Empty)" />
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group mb-3">
                                            <label for="DataNascimento" class="control-label">Data de Nascimento</label>
                                            <input id="DataNascimento" name="DataNascimento" class="form-control" type="date" value="@(voluntario?.DataNascimento?.ToString("yyyy-MM-dd") ?? string.Empty)" />
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group mb-3">
                                            <label for="Profissao" class="control-label">Profissão</label>
                                            <input id="Profissao" name="Profissao" class="form-control" value="@(voluntario?.Profissao ?? string.Empty)" />
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group mb-3">
                                            <label for="Disponibilidade" class="control-label">Disponibilidade</label>
                                            <input id="Disponibilidade" name="Disponibilidade" class="form-control" placeholder="Ex: Finais de semana, noites..." value="@(voluntario?.Disponibilidade ?? string.Empty)" />
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }                          <!-- Campos específicos de ONG -->                         
                        @if (Model.Tipo == TipoUsuario.Organizacao)
                        {
                            // Usar tipo completo Ong.Models.Ong para evitar problemas de namespace
                            var ong = Model as Ong;
                            <div id="camposONG">
                                <h5 class="mt-4">Informações da ONG</h5>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group mb-3">
                                            <label for="Cnpj" class="control-label">CNPJ</label>
                                            <input id="Cnpj" name="Cnpj" class="form-control" value="@(ong?.Cnpj ?? string.Empty)" />
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group mb-3">
                                            <label for="DataFundacao" class="control-label">Data de Fundação</label>
                                            <input id="DataFundacao" name="DataFundacao" class="form-control" type="date" value="@(ong?.DataFundacao?.ToString("yyyy-MM-dd") ?? string.Empty)" />
                                        </div>
                                    </div>
                                </div>
                                <div class="form-group mb-3">
                                    <label for="RazaoSocial" class="control-label">Razão Social</label>
                                    <input id="RazaoSocial" name="RazaoSocial" class="form-control" value="@(ong?.RazaoSocial ?? string.Empty)" />
                                </div>
                                <div class="form-group mb-3">
                                    <label for="NomeFantasia" class="control-label">Nome Fantasia</label>
                                    <input id="NomeFantasia" name="NomeFantasia" class="form-control" value="@(ong?.NomeFantasia ?? string.Empty)" />
                                </div>
                                <div class="form-group mb-3">
                                    <label for="Descricao" class="control-label">Descrição</label>
                                    <textarea id="Descricao" name="Descricao" class="form-control" rows="3">@(ong?.Descricao ?? string.Empty)</textarea>
                                </div>
                            </div>                        }
                        
                        <hr class="my-4" />
                        <h5 class="mb-3">Confirmação de Segurança</h5>
                        <div class="form-group mb-4">
                            <label for="Senha" class="control-label">Senha Atual</label>
                            <input type="password" id="Senha" name="Senha" class="form-control" required />
                            <small class="form-text text-muted">Digite sua senha atual para confirmar as alterações.</small>
                        </div>
                        
                        <div class="form-group mt-4">
                            <button type="submit" class="btn btn-primary btn-lg">Salvar Alterações</button>
                            <a asp-action="Perfil" class="btn btn-secondary btn-lg">Cancelar</a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://maps.googleapis.com/maps/api/js?key=@ViewBag.GoogleMapsApiKey&libraries=places" async defer></script>
    <script>
        $(document).ready(function() {
            // Inicializar um mapa oculto para geocodificação
            const map = new google.maps.Map(document.createElement('div'));
            const geocoder = new google.maps.Geocoder();

            // Função para geocodificar um endereço
            function geocodeAddress(address) {
                geocoder.geocode({ 'address': address }, function(results, status) {
                    if (status === 'OK') {
                        const location = results[0].geometry.location;
                        $('#latitude').val(location.lat());
                        $('#longitude').val(location.lng());
                        console.log("Coordenadas atualizadas: ", location.lat(), location.lng());
                    } else {
                        console.log("Geocodificação falhou: " + status);
                    }
                });
            }

            // Buscar dados do CEP quando for alterado
            $('#cep').blur(function() {
                const cep = $(this).val().replace(/\D/g, '');
                console.log("CEP inserido: " + cep);
                
                if (cep.length === 8) {
                    $.getJSON(`https://viacep.com.br/ws/${cep}/json/`, function(data) {
                        if (!data.erro) {
                            console.log("CEP encontrado: ", data);
                            $('#logradouro').val(data.logradouro);
                            $('#bairro').val(data.bairro);
                            $('#cidade').val(data.localidade);
                            $('#estado').val(data.uf);
                            
                            // Geocodificação para obter as coordenadas se o número já estiver preenchido
                            if ($('#numero').val()) {
                                const endereco = `${data.logradouro}, ${$('#numero').val()}, ${data.localidade}, ${data.uf}, Brasil`;
                                geocodeAddress(endereco);
                            }
                        } else {
                            console.log("CEP não encontrado");
                        }
                    }).fail(function() {
                        console.log("Erro ao buscar o CEP");
                    });
                }
            });
            
            // Quando o número é alterado, atualizar a geocodificação
            $('#numero').blur(function() {
                if ($('#logradouro').val()) {
                    const endereco = `${$('#logradouro').val()}, ${$(this).val()}, ${$('#cidade').val()}, ${$('#estado').val()}, Brasil`;
                    geocodeAddress(endereco);
                }
            });
            
            // Geocodificar o endereço completo quando os campos de endereço são alterados
            $('#cidade, #estado').blur(function() {
                if ($('#logradouro').val() && $('#numero').val() && $('#cidade').val() && $('#estado').val()) {
                    const endereco = `${$('#logradouro').val()}, ${$('#numero').val()}, ${$('#cidade').val()}, ${$('#estado').val()}, Brasil`;
                    geocodeAddress(endereco);
                }
            });
        });
    </script>
}
